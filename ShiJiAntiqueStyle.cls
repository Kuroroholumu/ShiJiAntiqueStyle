\NeedsTeXFormat{LaTeX2e}
\ProvidesClass{ShiJiAntiqueStyle}[2022/03/24 antique style typesetting for SHIJI]
%
\RequirePackage{type1cm}
\RequirePackage{catchfilebetweentags}
\RequirePackage{xcolor}
\RequirePackage{tikz}
  \usetikzlibrary{calc}
  \RequirePackage{eso-pic}
\RequirePackage{ifoddpage}
%
\RequirePackage{gezhu} % https://github.com/yang-le/gezhu
%
% ===== Antique Style: jlreq ================================================= % 
%
\LoadClass[%
  uplatex,tate,book,twoside,
  paper={180mm,280mm},
  jafontsize=32pt,baselineskip=1.3zh,
  line_length=21zw,number_of_lines=10, % 十行二十一字
  fore-edge=0.8zh,
  headfoot_verticalposition = 0.3zh,
  hanging_punctuation,
]{jlreq}
%
\jlreqsetup{}
%
\renewcommand{\jlreqparindent}{0\zw} % 正文段落不縮進
%
\renewcommand{\jlreqkanjiskip}{.0\zw plus .0\zw minus .0\zw} % 漢字間隔固定
%
\NewBlockHeading{prechapter}{1}{%
  % 標題風格: preShiji
  indent=0\jlreq@zw,
  lines=2,
  font={\normalsize\mainfont},
  subtitle_break=true,
  subtitle_format={#1},
  subtitle_indent=2\jlreq@zw,
  subtitle_font={\jlreq@keepbaselineskip{\mainfont\normalsize}},
  number=false,
  pagebreak=begin_with_odd_page,
}
\RenewBlockHeading{chapter}{1}{%
  % 標題風格: chapter
  indent=0\jlreq@zw,
  lines=3,
  label_format={史記第\thechapter},
  font={\normalsize\mainfont},
  subtitle_break=false,
  subtitle_format={#1},
  subtitle_indent=10\jlreq@zw,
  subtitle_font={\jlreq@keepbaselineskip{\notefont\normalsize}},
  pagebreak=begin_with_odd_page,
}
%
\NewPageStyle{preShiji}{%
  % 頁眉與頁碼 preShiji 
  tate,
  running_head_font={\mainfont},
  nombre_font={\mainfont},
  running_head_position=8\zw,
  nombre_position=4\zw,
  nombre={\kansuji\theframe},
  mark_format={_prechapter={#1}},
  odd_running_head={_prechapter},
  even_running_head={_prechapter},
}
%
\NewPageStyle{Shiji}{%
  % 頁眉與頁碼 Shiji 
  tate,
  running_head_font={\small\mainfont},
  nombre_font={\small\mainfont},
  running_head_position=8\zw,
  nombre_position=4\zw,
  nombre={\kansuji\thepage},
  mark_format={_chapter={#1}},
  odd_running_head={_chapter},
  even_running_head={_chapter},
}
%
% ===== Antique Style: DIY Commands ========================================== %
%
\newif\ifmodernstyle\modernstylefalse
%
\newcommand{\parswitch}{%
  \ifmodernstyle \par \else \nolinebreak \fi % 分段開關
}
%
\newcommand{\loadnotes}[2]{% 注插入
  \gezhu{\ExecuteMetaData[#1]{#2}}
}
%
\def\gezhufont{\fontsize{\jlreq@jafontsize}{.63\jlreq@jafontsize}\selectfont}
%
\everygezhu={\notefont\gezhufont}
\setgezhuraise{-.315\jlreq@jafontsize}
\beforegezhu={\nobreak}
\aftergezhu={\kern-1\zw}
%
\definecolor{shuiro}{cmyk}{0.00,0.85,1.00,0.00} % 朱色
%
\newcommand{\yin}[1]{%
  % 陰文符號
  \textcolor{shuiro}{\notefont ◀▶}\kern-2\zw\textcolor{white}{#1}%
}
%
\newcommand{\KAOZ}{\yin{考證}} % 考證
\newcommand{\SYIN}{\yin{索隱}} % 索隱
\newcommand{\JJIE}{\yin{集解}} % 集解
\newcommand{\ZHYI}{\yin{正義}} % 正義
%
% ===== Antique Style: DIY Fonts ============================================= %
%
% CJK fontの設定
% Ref: https://texwiki.texjp.org/?upTeX%2CupLaTeX
%
% For Antique Style
% 
% ShiJiFontsAntique-v: 1. 取消句讀符號的寬度
%                      2. 句讀符號移動到行間
%                      3. 置換了一些標點符號
%
\DeclareFontFamily{JT2}{mainfont}{}
\DeclareFontFamily{JY2}{mainfont}{}
\DeclareFontShape{JT2}{mainfont}{m}{n}{<->s*[1.0]ShiJiFontsAntique-v}{}
\DeclareFontShape{JY2}{mainfont}{m}{n}{ <->s*[1.0]ShiJiFontsAntique-v}{}
%
\DeclareFontFamily{JT2}{notefont}{}
\DeclareFontFamily{JY2}{notefont}{}
\DeclareFontShape{JT2}{notefont}{m}{n}{<->s*[1.0]ShiJiFontsAntique-v-c}{}
\DeclareFontShape{JY2}{notefont}{m}{n}{<->s*[1.0]ShiJiFontsAntique-v-c}{}
%
\DeclareRobustCommand\mainfont{\kanjifamily{mainfont}\selectfont}
\DeclareRobustCommand\notefont{\kanjifamily{notefont}\selectfont}
%
\AtBeginDvi{
%
% 預設 : ubjlreq-v -> uprml-v : GenRyuMin-SB
%
% 自訂 : Antique Style
%
%        ubjlreq-v -> ShiJiFontsAntique-v    -> uprml-v-an : GenRyuMin-SB-S80
%        ubjlreq-v -> ShiJiFontsAntique-v-c  -> uprml-v-c  : GenRyuMin-M-W6H8
%
%        uprml-v-an, uprml-v-c are copied of uprml-v
%
  \special{pdf:mapline uprml-v     UniJIS2004-UTF16-V GenRyuMin-SB    }
  \special{pdf:mapline uprml-v-an  UniJIS2004-UTF16-V GenRyuMin-SB-S80}
  \special{pdf:mapline uprml-v-c   UniJIS2004-UTF16-V GenRyuMin-R-W6H8}
}
%
% NOTES:
%
% GenRyuMin-SB-S80:
%
%  1. 基於源流明體（GenRyuMinJP-SB）
%  2. 將字形等比例縮小至80%，以營造字符間隔
%  3. S80 == Scaled to 80%
%  4. 特殊字符: 
%     U30FB "・" -> 進一步縮小至60%
%
% GenRyuMin-R-W6H8
%  1. 基於源流明體（GenRyuMinJP-R）
%  2. 將字形寬度縮小至60%
%  3. 將字形高度縮小至80%
%  4. W6H8 == Width scaled to 60% & Height scaled to 80%
%  5. 特殊字符: 
%     U25C0 "◀" -> 模仿陰文低紋
%     U25B6 "▶" -> 模仿陰文低紋
%     UFF0C U3002 UFF10 UFF12 U30FB 形狀微小修正
%
% *.ttf generated by "FontForge" ...
%
% ===== Antique Style: DIY Frames ============================================ %
%
% 仿武英殿二十四史本: 十行二十一字，小字雙行同，單魚尾，白口，左右雙邊
%
\newcommand{\pH}{\paperheight}   % for coordination calculation
\newcommand{\tH}{\textheight}    %
\newcommand{\bS}{\baselineskip}  %
\newcommand{\bK}{0.2\zh}         %
%
\def\LeftFramePath{%
  -- ++ (   10\bS,   0     ) % 十行: Baselineskip * 10
  -- ++ (  0.5\bS,   0     ) % 半行: Baselineskip / 2
  -- ++ (     \bK,   0     ) % 做出左右雙邊
  -- ++ (  0     ,      \bK) % 空出間隔
  -- ++ (  0     ,      \tH) % 行長二十一字
  -- ++ (  0     ,      \bK) % 空出間隔
  -- ++ (-    \bK,   0     ) % 做出左右雙邊
  -- ++ (-10.5\bS,   0     ) % 返回
}
%
\def\RightFramePath{%
  -- ++ (-  10\bS,   0     ) % 十行: Baselineskip * 10
  -- ++ (- 0.5\bS,   0     ) % 半行: Baselineskip / 2
  -- ++ (-    \bK,   0     ) % 做出左右雙邊
  -- ++ (  0     ,      \bK) % 空出間隔
  -- ++ (  0     ,      \tH) % 行長二十一字
  -- ++ (  0     ,      \bK) % 空出間隔
  -- ++ (     \bK,   0     ) % 做出左右雙邊
  -- ++ ( 10.5\bS,   0     ) % 返回
}
%
\def\LeftTailPath{%
  -- ++ (  0.5\bS,   0     )
  -- ++ (  0     ,-  0.80zw)
  -- ++ (- 0.5\bS,   0.50zw)
  -- cycle
}
%
\def\RightTailPath{%
  -- ++ (- 0.5\bS,   0     )
  -- ++ (  0     ,-  0.80zw)
  -- ++ (  0.5\bS,   0.50zw)
  -- cycle
}
%
\def\LeftFrame{%
  \begin{tikzpicture}[remember picture, overlay]
    %
    \coordinate (NW) at (current page.north west); % 基準點
    \coordinate (SW) at (current page.south west); % 基準點
    %
    % Set the starting point (SP): 
    % from (SW)
    %  1. Page width = 330.5mm, move up 1/2 page width;
    %  2. Text length = 21zw, move down 1/2 text length;
    %  3. Baselineskip = 1.5zh, move down 0.25 zh;
    %  4. See \def: \pH, \tH, \bS, \bK
    %
    \coordinate (SP) at ($(SW)+(0,0.5\pH)+(0,-0.5\tH)+(0,-\bK)$);
    %
    \draw[line width=4pt] % 左右雙邊
      (SP) \LeftFramePath; 
    % 
    \foreach \i in { 0.5\bS, 1.5\bS, 2.5\bS, 3.5\bS, 4.5\bS,
                     5.5\bS, 6.5\bS, 7.5\bS, 8.5\bS, 9.5\bS, 10.5\bS}
      \draw[very thin] % 欄綫
        (SP) ++ (\i,0) -- ++ (0,\bK) -- ++ (0,\tH) -- + (0,\bK);
    %
    % Create a "fish tail"
    % Set the Fish-tail starting point (FP):
    % from (NW)
    %  1. Page width = 330.5mm, move down 1/2 page width;
    %  2. Position = 7zw, move up 1/2 text length, move down 7zw;（天往下七字）
    %
    \coordinate (FP) at ($(NW)+(0,-0.5\pH)+(0,0.5\tH)+(0,-7zw)$);
    %
    \fill[black] (FP) \LeftTailPath; % 單魚尾
    %
    \draw[very thin]
      ($(FP)+(0,0.2zw)$) -- + (0.5\bS,0); 
    \draw[very thin]
      ($(FP)+(0,-0.5zw)$) -- + (0.5\bS,-0.5zw);
    %
    % Another Position = -3.5zw（地往上約三字半）
    %
    \draw[very thin]
      ($(SP)+(0,\bK)+(0,3.5zw)$) -- + (0.5\bS,0); 
    %
  \end{tikzpicture}
}
%
\def\RightFrame{%
  \begin{tikzpicture}[remember picture, overlay]
    %
    \coordinate (NE) at (current page.north east); % 基準點
    \coordinate (SE) at (current page.south east); % 基準點
    %
    % Set the starting point (SP): 
    % from (SE)
    %  1. Page width = 330.5mm, move up 1/2 page width;
    %  2. Text length = 21zw, move down 1/2 text length;
    %  3. Baselineskip = 1.5zh, move down 0.25 zh;
    %  4. See \def: \pH, \tH, \bS, \bK
    %
    \coordinate (SP) at ($(SE)+(0,0.5\pH)+(0,-0.5\tH)+(0,-\bK)$);
    %
    \draw[line width=4pt] % 左右雙邊
      (SP) \RightFramePath;  
    %
    \foreach \i in {-0.5\bS,-1.5\bS,-2.5\bS,-3.5\bS,-4.5\bS,
                    -5.5\bS,-6.5\bS,-7.5\bS,-8.5\bS,-9.5\bS,-10.5\bS}
      \draw[very thin] % 欄綫
        (SP) ++ (\i,0) -- ++ (0,\bK) -- ++ (0,\tH) -- + (0,\bK);
    %
    % Create a "fish tail"
    % Set the Fish-tail starting point (FP):
    % from (NE)
    %  1. Page width = 330.5mm, move down 1/2 page width;
    %  2. Position = 7zw, move up 1/2 text length, move down 7zw;（天往下七字）
    %
    \coordinate (FP) at ($(NE)+(0,-0.5\pH)+(0,0.5\tH)+(0,-7zw)$);
    %
    \fill[black] (FP) \RightTailPath; % 單魚尾
    %
    \draw[very thin]
      ($(FP)+(0,0.2zw)$) -- + (-0.5\bS,0); 
    \draw[very thin]
      ($(FP)+(0,-0.5zw)$) -- + (-0.5\bS,-0.5zw);
    %
    % Another Position = -3.5zw（地往上三字半）
    %
    \draw[very thin]
      ($(SP)+(0,\bK)+(0,3.5zw)$) -- + (-0.5\bS,0); 
    %
  \end{tikzpicture}
}
%
\newcounter{frame}
%
\newcommand{\MakeFrame}{\AddToShipoutPictureBG{\checkoddpage % 繪製板框圖案
    \ifoddpage
      \LeftFrame
    \else
      \RightFrame\stepcounter{frame}
    \fi
  }
}
